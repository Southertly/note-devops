# SSH隧道,端口转发与内网穿透(二)

参考文章

1. [SSH隧道技术简介](http://blog.sina.com.cn/s/blog_6ca2bddf0100rljn.html)
2. [SSH的三种端口转发](https://jeremyxu2010.github.io/2018/12/ssh%E7%9A%84%E4%B8%89%E7%A7%8D%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/)
3. [windows10自带ssh实现远程内网主机](https://blog.csdn.net/zhj082/article/details/80795998)
    - win10自带的ssh客户端的使用方法与linux的相同

## 1. 自动重连

隧道可能因为某些原因断开, 例如：机器重启, 长时间没有数据通信而被路由器切断等等. 

因此我们可以用程序控制隧道的重新连接, 例如一个简单的循环或者使用djb’s daemontools. 不管用哪种方法, 重连时都应避免因输入密码而卡死程序. 

其实自动重连功能可以通过`autossh`工具完成, 下面会单独介绍.

## 2. 保持长时间连接

有些路由器会把长时间没有通信的连接断开. SSH客户端的`TCPKeepAlive`选项可以避免这个问题的发生, 默认情况下它是被开启的. 如果它被关闭了, 可以在ssh的命令上加上`-o TCPKeepAlive=yes`来开启. 如下

```
ssh -N -f -L 8080:目标服务器IP:80 -o TCPKeepAlive=yes root@中转服务器IP
ssh -N -f -R 2222:127.0.0.1:22 -o TCPKeepAlive=yes root@中转服务器IP
ssh -N -f -D 1080 -o TCPKeepAlive=yes root@中转服务器IP
```

另一种方法是, 去掉`-N`参数, 加入一个定期能产生输出的命令. 例如: `top`或者`vmstat`. 下面给出一个这种方法的例子：

```
ssh -R 2222:127.0.0.1:22 root@中转服务器IP "vmstat 30"
```

## 3. 检查隧道状态

有些时候隧道会因为一些原因通信不畅而卡死, 例如：由于传输数据量太大, 被路由器带入stalled状态. 

这种时候, 往往SSH客户端并不退出, 而是卡死在那里. 

一种应对方法是, 使用SSH客户端的`ServerAliveInterval`和`ServerAliveCountMax`选项.  

`ServerAliveInterval`会在隧道无通信后的一段设置好的时间后发送一个请求给服务器要求服务器响应. 如果服务器在 `ServerAliveCountMax`次请求后都没能响应, 那么SSH客户端就自动断开连接并退出, 将控制权交给你的监控程序. 

这两个选项的设置方法分别是在ssh时加入`-o ServerAliveInterval=m`和`-o ServerAliveCountMax=n`. 其中m, n可以自行定义. 

## 4. 如何将端口绑定到外部地址上

在使用上一篇文章的`2.1`和`2.3`时, 映射的端口只能绑定在第三方服务器的`127.0.0.1`这个接口上. 也就是说, 只能被本机自己访问到, 要访问到被穿透的内网, 要先登录第三方服务器再跳转一次才行. 如何才能让其他机器访问这个端口呢? 直接通过`第三方服务器IP:映射的端口`去访问内网?

我们可以把这个映射的端口绑定在`0.0.0.0`的接口上, ~~方法是加上参数`-b 0.0.0.0`. 如下~~

~~ssh -N -f -L 2222:目标服务器IP:22 -b 0.0.0.0 root@中转服务器IP~~

~~ssh -N -f -D 1080 -b 0.0.0.0 root@中转服务器IP~~


`-b`参数没什么用, 参考文章2中说到, `-R`选项的用法为`-R [登录主机:]登录主机端口:本地网络主机:本地网络主机端口`, 所以把`[登录主机]`的部分写为`0.0.0.0`.

```
ssh -N -f -R 0.0.0.0:2222:127.0.0.1:22 root@中转服务器IP
```

同时**SSH服务端**还需要打开`GatewayPorts`选项. 默认情况下它应当是被打开的. 如果被关闭的话, 可以在`/etc/sshd_config`中修改`GatewayPorts no`为`GatewayPorts yes`, 并重启sshd服务.

这样在中转服务端就有了在`0.0.0.0`接口上的监听

```
netstat -nlp | grep 2222
tcp        0      0 0.0.0.0:2222          0.0.0.0:*               LISTEN      32241/sshd: root
tcp6       0      0 :::2222                 :::*                    LISTEN      787/sshd: root
```

> 实际上我发现只要打开服务端的`GatewayPorts`字段而不需要ssh的`-b`选项就可以了.

## 5. socks代理与autossh

在使用自建VPS玩翻墙时, 经常看到`autossh`这个工具. 其典型的使用方法如下

在本地linux虚拟机上执行

```
autossh -M 5678 -D 1080 -qTfNn 用户名@vps地址
```

然后使用xshell等工具建立与本地linux虚拟机的ssh连接, 同时创建一个动态转发端口, 端口号指定为1080. 在ssh会话连接期间, 就可以通过chrome指定代理端口为本地的1080去快乐地翻墙了.

其实autossh只是一个监视ssh会话的小工具, 它自己只有3个参数: `-M`, `-f`, `-V`. 其他的参数都是要传递给ssh命令的的. 上面的命令也是上一篇文章`2.3`中介绍的socks代理的动态端口的应用.

`-M`指定了一个克隆端口, 它通过这个端口来检测当前ssh连接的状态, 一但有问题就会尝试重连.

`-f`选项不会传递给ssh, 而是会被autossh捕获. 不过作用其实和ssh的一样, 也是作为后台进程运行的. 有一点区别是, 在使用了`-f`选项后, 此次ssh连接就没有办法接收密码的, 所以只能用key的方式连接.

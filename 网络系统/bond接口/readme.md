# bond网卡模式

参考文章

1. [Linux 网卡bond的七种模式](https://www.jianshu.com/p/b93027ae1e94)
    - 详细介绍了网卡bond的七种模式各自的特点及优缺点.
    - 简单的配置实例(`ifcfg`配置, 但是配置文件太繁琐了, 很多无用的字段)
2. [Linux双网卡绑定bond详解](https://blog.51cto.com/lixin15/1769338)
    - vmware中的bond测试实例
3. [10.6. VLAN ON BOND AND BRIDGE USING IP COMMANDS](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-vlan_on_bond_and_bridge_using_ip_commands)
    - `bond`命令示例
4. [阿里云官方文档 - 配置弹性网卡](https://help.aliyun.com/document_detail/56955.html)
5. [Linux下Bond技术实现平衡负载](https://blog.51cto.com/10316297/2116352)
    - 双网卡虚拟机配置bond负载均衡模式, `ifcfg`配置

`bond`机制有7种模式, 常用只有3种:

1. `mode0` 平衡负载模式: 平时两块网卡工作, 且自动备援, 但需要在服务器本机网卡相连的交换机设备上进行端口聚合来支持绑定技术; 
2. `mode1` 自动备援技术: 平时只有一块网卡工作, 在它故障后自动替换为另外的网卡; 
3. `mode6` 平衡负载模式: 平时两块网卡均工作, 且自动备援, 无须交换机设备提供辅助支持; 

> 网卡bond是通过多张网卡绑定为一个逻辑网卡, 实现本地网卡的冗余, 带宽扩容和负载均衡(感觉很像LVM有木有?)

bond不属于虚拟化的技术, 只是linux的网络系统机制.

bond的基本原理很简单, 难的是应用场景.

```

                +--------+                   +--------+  
                |  eip1  |                   |  eip2  |               EIP
                +--------+                   +--------+  
                     ↑                            ↑    
---------------------|----------------------------|-------------------------
                     |                            |      
              +------|----------------------------|-----+
              |      ↓                            ↓     |
              | +--------+                   +--------+ |
              | |  eth0  |                   |  eth1  | |
              | +--------+                   +--------+ |
              |      ↑                            ↑     |
              |      +-------------+--------------+     |
              |                    ↓                    |             ECS
              |                 +-----+                 |
              |                 |bond0|                 |
              |                 +-----+                 |
              |                    ↓                    |
              | +------------------------------------+  |
              | |   Newwork     Protocol     Stack   |  |
              | +------------------------------------+  |
              +-----------------------------------------+
```

修改`ifcfg-eht1`中的`DEFROUTE=yes|no`字段的值, 然后重启eth1接口, 可以看到默认路由在`eth0`和`eth1`之间转换.

```
## 默认走eth0网卡
default via 172.16.159.253 dev eth0
## 默认走eth1网卡
default via 172.16.159.253 dev eth1
```

然后`curl cip.cc`时就可以看到不同的出口IP.

一启动`bond0`, 就断网了, 远程连接无法ping通过外网(内网之间倒还好), 办公环境对两个EIP都ping不通.

------

就算能访问外网, 且能实现负载均衡或是主备切换, 但是出口IP变动势必影响业务服务.

而且这还是针对主动服务, 如爬虫这种. 更多的是作为http服务, 等待用户来访问. bond技术对这种需要貌似没有任何帮助.

我觉得更多的应该是服务器上两块网卡连接同一子网, IDC的出口点与入口点同时与两块网卡建立连接, 这样可以防止服务器上某块网卡的物理损坏对业务造成的影响.

负载均衡模式下包同时从eth0/eth1流出, 然后由出口交换机做汇聚(否则出去的包都是乱序的), 这个需要对交换机做配置.

```

                +--------+                   +--------+  
                | egress |                   | ingress|               NAT(出口IP/入口IP)
                +--------+                   +--------+  
                     ↑                            ↓   
---------------------|----------------------------|-------------------------
                     +------------ ┬ -------------+      
                                 +---+                 
                                 |   |                 
                                 +---+                 
                     +------------ ┴ -------------+      
---------------------|----------------------------|-------------------------
              +------|----------------------------|-----+
              |      ↑                            ↓     |
              | +--------+                   +--------+ |
              | |  eth0  |                   |  eth1  | |
              | +--------+                   +--------+ |
              |      ↑                            ↑     |
              |      +-------------+--------------+     |
              |                    ↓                    |             ECS
              |                 +-----+                 |
              |                 |bond0|                 |
              |                 +-----+                 |
              |                    ↓                    |
              | +------------------------------------+  |
              | |   Newwork     Protocol     Stack   |  |
              | +------------------------------------+  |
              +-----------------------------------------+
```

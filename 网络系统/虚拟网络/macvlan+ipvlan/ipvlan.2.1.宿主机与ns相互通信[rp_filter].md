# ipvlan.2.宿主机与ns相互通信[rp_filter]

参考文章

1. [K8S CNI之：利⽤ ipvlan + host-local 打通容器与宿主机的平⾏⽹络](https://juejin.cn/post/6844903801057443853)
    - 借助`ptp`原理实现在macvlan/ipvlan模型下容器与宿主机网络互通.
2. [K8S CNI之：利用ipvlan+host-local+ptp打通容器与宿主机的平行网络](https://hansedong.github.io/2019/03/19/14/)
    - 参考文章1的原链接
3. [Linux网络协议栈6--ipvlan](https://www.jianshu.com/p/783fe769f335)
    - 场景有效, 但是示例中错误太多...太难了
4. [Kubernetes网络的IPVlan方案](https://kernel.taobao.org/2019/11/ipvlan-for-kubernete-net/)

本示例使用L2模式的ipvlan构建网络拓扑, 用以实现宿主机与`namespace`中的ipvlan设备进行通信, 借鉴自参考文章3.

## 环境准备

VMware Nat网络模式

- vm01: 172.16.91.10/24
- vm02: 172.16.91.14/24

网关与DNS地址都是`172.16.91.2`.

## 构建网络拓扑

### 1. 

在vm02上执行如下命令, 创建两个ipvlan设备, 并分别放入2个ns中.

```bash
ip link add link ens34 ipvlan1 type ipvlan mode l2
ip link add link ens34 ipvlan2 type ipvlan mode l2

## 创建ns
ip net add ns01
ip net add ns02

## 将 ipvlan 设备分为移入指定ns
ip link set ipvlan1 netns ns01
ip link set ipvlan2 netns ns02

## 要先将 ipvlan 设备放入 ns, 然后设置IP, 否则移入后地址会被置空
ip net exec ns01 ip addr add 172.16.91.101/24 dev ipvlan1
ip net exec ns02 ip addr add 172.16.91.102/24 dev ipvlan2
ip net exec ns01 ip link set ipvlan1 up
ip net exec ns02 ip link set ipvlan2 up

## 设置默认路由
## 注意!!!这里设置的网关为父级接口的IP
ip net exec ns01 ip route add default via 172.16.91.14 dev ipvlan1 onlink
ip net exec ns02 ip route add default via 172.16.91.14 dev ipvlan2 onlink
```

到这里, 构建出的网络模型与上一篇基本没有差别, 网络连通表现如下

1. ns01与ns01可以互相ping通;
2. ns01, ns02可以与vm01互相ping通, 同时还可以ping通宿主机网络中的网关`172.16.91.2`;
3. ns01, ns02无法与宿主机vm02上的父接口ping通;

```
        VMware01                                                 VMware02                 
+-------------------+                          +----------------------------------------+
|                   |                          |         ns01                ns02       |
|                   |                          |  +----------------+ +----------------+ |
|                   |                          |  |172.16.91.101/24| |172.16.91.102/24| |
|                   |                          |  |    macvlan1    | |    macvlan2    | |
|                   |                          |  +-------┬--------+ +--------┬-------+ |
|                   |                          |          |                   |         |
|                   |                          |          └─────────┬─────────┘         |
|                   |                          |                    |                   |
| +---------------+ |                          |           +--------┴-------+           |
| |172.16.91.10/24| |                          |           |172.16.91.14/24 |           |
| |     ens34     | |                          |           |      ens34     |           |
| +-------┬-------+ |                          |           +--------┬-------+           |
+---------|---------+                          +--------------------|-------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

### 2. 中转设备ipvlan0

vm02想要与namespace中的ipvlan设备通信, 需要借助另外一个放置在host namespace的ipvlan设备 - `ipvlan0`.

```bash
ip link add link ens34 ipvlan0 type ipvlan mode l2
## 注意: `ipvlan0`上的所配置的IP, 可以随便写, 好像没有多大关系
## 而且ipvlan0只是作为宿主机与ns中的ipvlan设备通信的一个中转而已, 所以一个32位的掩码就可以了.
## 拥有32位掩码的设备在启动时不会自动生成到`192.168.1.1/xx`网络的路由, 但是会将数据包发送到宿主机的内核协议栈.
ip addr add 192.168.1.1/32 dev ipvlan0
ip link set ipvlan0 up
ip r add 172.16.91.101 dev ipvlan0 
ip r add 172.16.91.102 dev ipvlan0 
```

此时, 网络拓扑如下

```
        VMware01                                                 VMware02                 
+-------------------+                          +------------------------------------------------------+
|                   |                          |         ns01                ns02                     |
|                   |                          |  +----------------+ +----------------+               |
|                   |                          |  |172.16.91.101/24| |172.16.91.102/24|               |
|                   |                          |  |    macvlan1    | |    macvlan2    |               |
|                   |                          |  +-------┬--------+ +--------┬-------+               |
|                   |                          |          |                   |                       |
|                   |                          |          └─────────┬─────────┘                       |
|                   |                          |                    |                                 |
| +---------------+ |                          |           +--------┴-------+      +---------------+  |
| |172.16.91.10/24| |                          |           |172.16.91.14/24 |      | 192.168.1.1/32|  |
| |     ens34     | |                          |           |      ens34     ├──────┤    ipvlan0    |  |
| +-------┬-------+ |                          |           +--------┬-------+      +---------------+  |
+---------|---------+                          +--------------------|---------------------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

网络连接表现如下

1. 在vm02上, 可以直接ping通ns01和ns02;
2. 在ns01和ns02内部, 仍然无法ping通父级接口`172.16.91.14`;
3. 在ns01和ns02内部, 可以ping通过vm02上的`ipvlan0`设备.

```console
$ ip netns exec ns01 ping 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
64 bytes from 192.168.1.1: icmp_seq=1 ttl=64 time=0.063 ms
64 bytes from 192.168.1.1: icmp_seq=2 ttl=64 time=0.064 ms
^C
```

### 3. rp_filter

其实按照参考文章3, 到上一步理论上就应该可以实现宿主机与ns的相互通信了, 但是仍然未成功, 为此纠结了2天...

参考文章3提到过需要修改宿主机父接口的`rp_filter`配置为0或2, 我的宿主机默认值为1.

```console
$ cat /proc/sys/net/ipv4/conf/ens34/rp_filter
1
```

我将这个配置修改为0, 但是ns还是没法ping通宿主机, 为此又纠结了1天...

后来将这个配置修改为了2, 竟然就可以了...

```
echo 2 > /proc/sys/net/ipv4/conf/ens34/rp_filter
```

------

参考文章3中ns内部要ping的地址为`170.171.0.1/32`, 是配置在`lo`环回网卡上的, 没区别, 只要上面的通了, lo上配置什么就都能通了(当然前提是ns中有到这个地址的路由)

## 回路分析

上面的两张拓扑图还是没有办法显示出数据包的流向.

```
        VMware01                                                 VMware02                 
+-------------------+                          +------------------------------------------------------+
|                   |                          |         ns01                ns02                     |
|                   |                          |  +----------------+ +----------------+               |
|                   |                          |  |172.16.91.101/24| |172.16.91.102/24|               |
|                   |                          |  |    macvlan1    | |    macvlan2    |               |
|                   |                          |  +-------┬--------+ +--------┬-------+               |
|                   |                          |          |                   |                       |
|                   |                          |          └─────────┬─────────┘                       |
|                   |                          |                    |                                 |
| +---------------+ |                          |           +--------┴-------+      +---------------+  |
| |172.16.91.10/24| |                          |           |172.16.91.14/24 |      | 192.168.1.1/32|  |
| |     ens34     | |                          |           |      ens34     ├──────┤    ipvlan0    |  |
| +-------┬-------+ |                          |           +--------┬-------+      +---------------+  |
+---------|---------+                          +--------------------|---------------------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

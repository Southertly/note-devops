# ipvlan.1.1.ipvlan设备互通-同一子网[L2 L3]

参考文章

1. [Macvlan 和 IPvlan](https://www.cnblogs.com/menkeyi/p/11374023.html)
    - IPvlan分为两种工作模式: L2/L3

ipvlan是基于物理网卡设备创建的虚拟设备, 一个物理网卡可以创建多个ipvlan设备, 这些ipvlan设备可以互相通信.

## 环境准备

VMware Nat网络模式

- vm01: 172.16.91.10/24
- vm02: 172.16.91.14/24

网关与DNS地址都是`172.16.91.2`.

## L2 vs L3 - Round 1(同一子网)

### L2

在vm02上执行如下命令, 创建两个ipvlan设备, 并分别放入2个ns中.

```bash
ip link add link ens34 ipvlan1 type ipvlan mode l2
ip link add link ens34 ipvlan2 type ipvlan mode l2

## 创建ns
ip net add ns01
ip net add ns02

## 将 ipvlan 设备分为移入指定ns
ip link set ipvlan1 netns ns01
ip link set ipvlan2 netns ns02

## 要先将 ipvlan 设备放入 ns, 然后设置IP, 否则移入后地址会被置空
ip net exec ns01 ip addr add 172.16.91.101/24 dev ipvlan1
ip net exec ns02 ip addr add 172.16.91.102/24 dev ipvlan2
ip net exec ns01 ip link set ipvlan1 up
ip net exec ns02 ip link set ipvlan2 up
```

在宿主机namespace下, 创建一个对比设备`ipvlan0`.

```bash
ip link add link ens34 ipvlan0 type ipvlan mode l2
ip addr add 172.16.91.100/32 dev ipvlan0
ip link set ipvlan0 up
```

> **⚠️警告**: 放置在宿主机上的`ipvlan0`设备地址不可配置为与宿主机主网卡同一子网及掩码, 比如`172.16.91.100/24`, 这会由于IP冲突造成网络中断.

```
        VMware01                                                 VMware02                 
+-------------------+                          +-------------------------------------------------------+
|                   |                          |         ns01                ns02                      |
|                   |                          |  +----------------+ +----------------+                |
|                   |                          |  |172.16.91.101/24| |172.16.91.102/24|                |
|                   |                          |  |    ipvlan1     | |     ipvlan2    |                |
|                   |                          |  +-------┬--------+ +--------┬-------+                |
|                   |                          |          |                   |                        |
|                   |                          |          └─────────┬─────────┘                        |
|                   |                          |                    |                                  |
| +---------------+ |                          |           +--------┴--------+      +----------------+ |
| |172.16.91.10/24| |                          |           | 172.16.91.14/24 |      |172.16.91.100/32| |
| |     ens34     | |                          |           |      ens34      ├──────┤    ipvlan0     | |
| +-------┬-------+ |                          |           +--------┬--------+      +----------------+ |
+---------|---------+                          +--------------------|----------------------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

此时的网络连通表现如下

- [x] ns01 <-------> ns02
- [x] ns01/ns02 <--> vm01(`172.16.91.10`)
- [x] ns01/ns02 <--> Gateway(`172.16.91.2`)
- [ ] ns01/ns02 <--> vm02.ipvlan0(`172.16.91.100`)
- [ ] ns01/ns02 ---> vm02.ens34(`172.16.91.14`)

在vm02宿主机上添加如下路由, 通过`ipvlan0`设备指向`ns01`/`ns02`.

```
ip r add 172.16.91.101 dev ipvlan0
ip r add 172.16.91.102 dev ipvlan0
```

网络连通表现变为了

- [x] ns01 <-------> ns02
- [x] ns01/ns02 <--> vm01(`172.16.91.10`)
- [x] ns01/ns02 <--> Gateway(`172.16.91.2`)
- [x] ns01/ns02 <--> vm02.ipvlan0(`172.16.91.100`)
- [ ] ns01/ns02 ---> vm02.ens34(`172.16.91.14`)

> 其实`ipvlan0`的IP地址是多少都无所谓(只要不与宿主机主网卡处于同一网段, 相同掩码), 因为ipvlan设备之间的通信走的是内核协议栈的内部通道, 只要配置了路由就行.

### L3

首先将网络恢复(重启vm02即可), 然后重新开始.

在vm02上执行如下命令, 创建两个ipvlan设备, 并分别放入2个ns中.

```bash
ip link add link ens34 ipvlan1 type ipvlan mode l3
ip link add link ens34 ipvlan2 type ipvlan mode l3

## 创建ns
ip net add ns01
ip net add ns02

## 将 ipvlan 设备分为移入指定ns
ip link set ipvlan1 netns ns01
ip link set ipvlan2 netns ns02

## 要先将 ipvlan 设备放入 ns, 然后设置IP, 否则移入后地址会被置空
ip net exec ns01 ip addr add 172.16.91.101/24 dev ipvlan1
ip net exec ns02 ip addr add 172.16.91.102/24 dev ipvlan2
ip net exec ns01 ip link set ipvlan1 up
ip net exec ns02 ip link set ipvlan2 up
```

在宿主机namespace下, 创建一个对比设备`ipvlan0`.

```bash
ip link add link ens34 ipvlan0 type ipvlan mode l3
ip addr add 172.16.91.100/32 dev ipvlan0
ip link set ipvlan0 up
```

本示例与上面L2的示例相比, 网络拓扑, 连通性都没有任何区别, 手动在vm02上添加到`172.16.91.101`和`172.16.91.102`的路由后, 也实现了`ns01/ns02`与`ipvlan0`的相互通信. 

这让我有些怀疑, ipvlan设备的L2/L3究竟有什么区别?

## L2 vs L3 - 区别之处

以下网络模型是我瞎掰的...

### L3

```
        VMware01                                                 VMware02                 
+-------------------+              +-------------------------------------------------------------------+
|                   |              |         ns01                                          ns02        |
|                   |              |  +----------------+   +-----------------+     +----------------+  |
|                   |              |  |172.16.91.101/24|   |172.16.91.100/24 |     |172.16.91.102/24|  |
|                   |              |  |    ipvlan1     |   |     ipvlan0     |     |     ipvlan2    |  |
|                   |              |  +-------┬--------+   +--------┬--------+     +--------┬-------+  |
|                   |              |          |                     |                       |          |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |      |   |          Network    |    Stack              |   |      |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |      |   └         L3          ┴            L3         ┘   |      |
|                   |              |      +-----------------------------------------------------+      |
|                   |              |      |             L2                       L2             |      |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |          |                     |                       |          |
|                   |              |          └─────────────────────┼───────────────────────┘          |
|                   |              |                                |                                  |
| +---------------+ |              |                       +--------┴--------+                         |
| |172.16.91.10/24| |              |                       | 172.16.91.14/24 |                         |
| |     ens34     | |              |                       |      ens34      |                         |
| +-------┬-------+ |              |                       +--------┬--------+                         |
+---------|---------+              +--------------------------------|----------------------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

L3的ipvlan网络, 3个ipvlan设备只接入到了网络协议栈的L3层, 可以认为ipvlan L3的driver驱动, 就工作在这一层.

在该网络模型下, 进入`ns01`, ping`172.16.91.100`时, 由于路由的存在, `icmp`数据包将从`ipvlan1`发出, 送往内核协议栈, 从L7一直向下, 进入L3时, `driver`发现目标也接入了L3, 数据包会直接被直接返回给`ipvlan0`. 

在这期间对`ens34`设备抓包, 是抓不到`icmp`数据的.

另外, 如果用`arping`命令, 准备向`172.16.91.100`发送2层包, 就会直接返回失败.

```
$ arping 172.16.91.100 -I ipvlan1
Interface "ipvlan1" is not ARPable
```

ens34上也接收不到任何来自ipvlan设备的2层arp包.

### L2

```
        VMware01                                                 VMware02                 
+-------------------+              +-------------------------------------------------------------------+
|                   |              |         ns01                                          ns02        |
|                   |              |  +----------------+   +-----------------+     +----------------+  |
|                   |              |  |172.16.91.101/24|   |172.16.91.100/24 |     |172.16.91.102/24|  |
|                   |              |  |    ipvlan1     |   |     ipvlan0     |     |     ipvlan2    |  |
|                   |              |  +-------┬--------+   +--------┬--------+     +--------┬-------+  |
|                   |              |          |                     |                       |          |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |      |   |          Network    |    Stack              |   |      |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |      |   |         L3          |            L3         |   |      |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |      |   └         L2          ┴            L2         ┘   |      |
|                   |              |      +---|---------------------|-----------------------|---+      |
|                   |              |          |                     |                       |          |
|                   |              |          └─────────────────────┼───────────────────────┘          |
|                   |              |                                |                                  |
| +---------------+ |              |                       +--------┴--------+                         |
| |172.16.91.10/24| |              |                       | 172.16.91.14/24 |                         |
| |     ens34     | |              |                       |      ens34      |                         |
| +-------┬-------+ |              |                       +--------┬--------+                         |
+---------|---------+              +--------------------------------|----------------------------------+
          |          +-----------|----------+                       |                    
          |          |                      |                       |                    
          └─────────>|    172.16.91.2/24    |<──────────────────────┘                    
                     |        Gateway       |
                     +----------------------+
```

在该网络模型下, 进入`ns01`, ping`172.16.91.100`时, 由于路由的存在, `icmp`数据包将从`ipvlan1`发出, 送往内核协议栈, 从L7一直向下, 进入L2, 数据包才会被返回给`ipvlan0`. 对`ens34`设备进行抓包, 仍然没有数据.

不过这次再使用`arping`向`172.16.91.100`发送2层包(在`ns01`中), 就可以看到如下结果了.

```console
$ arping 172.16.91.100 -I ipvlan1
ARPING 172.16.91.100 from 172.16.91.101 ipvlan1
Unicast reply from 172.16.91.100 [00:0C:29:51:4C:E0]  0.696ms
Unicast reply from 172.16.91.100 [00:0C:29:51:4C:E0]  0.558ms
```

在ns01中`arping 172.16.91.14`, 仅会得到1次广播包回应, 不过在ens34上还是可以接收到`arp`请求包的. 

```console
$ arping 172.16.91.14
ARPING 172.16.91.14 from 172.16.91.101 ipvlan1
Unicast reply from 172.16.91.14 [00:0C:29:51:4C:E0]  0.627ms
^CSent 5 probes (1 broadcast(s))
```
